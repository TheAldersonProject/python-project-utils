name: Validate and Merge

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      
      - name: Install UV
        run: |
          make install-uv
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      
      - name: Set up virtual environment
        run: |
          make local-dev-config
          source .venv/bin/activate
      
      - name: Install dependencies
        run: make install
      
      - name: Run Ruff Check
        run: make check
      
      - name: Run Pytest with coverage
        run: make test
  
  auto-merge:
    name: Auto-merge to Main
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    
    steps:
      - name: Auto-merge
        if: github.event.pull_request.user.login != 'dependabot[bot]'
        uses: pascalgn/automerge-action@v0.15.6
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          MERGE_LABELS: "ready-to-merge,!work-in-progress"
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title"
          MERGE_REQUIRED_APPROVALS: "1"
          MERGE_DELETE_BRANCH: "true"